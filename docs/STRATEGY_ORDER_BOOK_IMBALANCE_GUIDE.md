# Order Book Imbalance (호가창 불균형) 전략 가이드

## 개요

호가창(Order Book)의 매수호가(Bid)와 매도호가(ask) 불균형을 분석하여 초단기 가격 방향을 예측하는 전략입니다. 매수량이 많으면 가격 상승, 매도량이 많으면 가격 하락합니다.

## 작동 원리

### 기본 원리

```
[호가창 구조]
┌─────────────────────────────────────┐
│ 매도(ASK)              매수(BID)│
│                             │
│  5100만원(10 BTC)   4900만원(8 BTC)
│  5000만원(5 BTC)     4850만원(15 BTC)
│  4950만원(3 BTC)     4800만원(12 BTC)
│  4880만원(2 BTC)     4750만원(8 BTC)
│  4800만원(5 BTC)     4700만원(10 BTC)
└─────────────────────────────────────┘

[매수량 > 매도량]
  → 매수 압력 강함 → 가격 상승 예측
  → Imbalance = +30% → 매수(BUY) 신호

[매수량 < 매도량]
  → 매도 압력 강함 → 가격 하락 예측
  → Imbalance = -25% → 매도(SELL) 신호
```

### 메커니즘

| 단계 | 조건 | 동작 |
|------|------|------|
| 1. | 호가창 조회 | 상위 5호가 사용 |
| 2. | 매수/매도량 계산 | `bidVolume = Σ(bidPrice × bidSize)` |
| 3. | | `askVolume = Σ(askPrice × askSize)` |
| 4. | Imbalance 계산 | `(bidVolume - askVolume) / (bidVolume + askVolume)` |
| 5. | | +0.3 이상 → BUY, -0.3 이하 → SELL |
| 6. | 연속 확인 | 같은 방향 3회 연속 시 신호 강화 |
| 7. | 주문 진입 | 신호가로 지정가 주문 |

---

## 진입/청산 조건

### 진입 조건 (BUY - 매수)

| 조건 | 값 | 설명 |
|------|-----|------|
| Imbalance | ≥ +0.3 | 매수량이 매도량보다 30% 이상 많음 |
| 연속 확인 | 3회 | BUY 신호 3회 연속 (강한 신호) |
| 최소 예상 이동 | ≥ 0.3% | 수수료+슬리피지 커버 |

### 진입 조건 (SELL - 매도)

| 조건 | 값 | 설명 |
|------|-----|------|
| Imbalance | ≤ -0.3 | 매도량이 매수량보다 30% 이상 많음 |
| 연속 확인 | 3회 | SELL 신호 3회 연속 (강한 신호) |
| 최소 예상 이동 | ≥ 0.3% | 수수료+슬리피지 커버 |

---

## Imbalance 계산

### 공식

```
Imbalance = (bidVolume - askVolume) / (bidVolume + askVolume)

bidVolume  = Σ(매수호가 가격 × 매수호가 수량)
askVolume  = Σ(매도호가 가격 × 매도호가 수량)
```

### 해석

| Imbalance | 의미 | 신호 |
|-----------|------|------|
| +0.3 ~ +0.5 | 약한 매수 우위 | - |
| +0.5 ~ +0.8 | 강한 매수 우위 | BUY (확정) |
| +0.8 이상 | 매우 강한 매수 우위 | BUY (확정) |
| -0.3 ~ -0.5 | 약한 매도 우위 | - |
| -0.5 ~ -0.8 | 강한 매도 우위 | SELL (확정) |
| -0.8 이상 | 매우 강한 매도 우위 | SELL (확정) |

---

## 설정 파라미터

### application.yml

```yaml
trading:
  # Order Book Imbalance 전략 활성화
  strategy:
    type: ORDER_BOOK_IMBALANCE

  # Imbalance 설정
  imbalance-threshold: 0.3    # 불균형 임계값 (±30%)
  strong-imbalance: 0.5      # 강한 불균형 기준 (±50%)
  consecutive-count: 3         # 연속 확인 횟수
  min-expected-move: 0.3     # 최소 예상 이동 (%)
```

### 런타임 API 변경

```bash
# 불균형 임계값 변경 (0.3 → 0.25)
curl -X POST http://localhost:8080/api/settings \
  -H "Content-Type: application/json" \
  -d '{"key": "trading.strategy.imbalanceThreshold", "value": "0.25"}'

# 연속 확인 횟수 변경 (3 → 5)
curl -X POST http://localhost:8080/api/settings \
  -H "Content-Type: application/json" \
  -d '{"key": "trading.strategy.consecutiveCount", "value": "5"}'
```

---

## 사용법

### 1. 전략 활성화

```yaml
# application.yml
trading:
  enabled: true
  strategy:
    type: ORDER_BOOK_IMBALANCE
```

### 2. 마켓 설정

```yaml
trading:
  markets:
    - KRW-BTC
    - KRW-ETH
    - KRW-XRP
```

### 3. 상태 확인

```bash
# 전체 트레이딩 상태
curl http://localhost:8080/api/trading/status

# 특정 마켓 분석
curl http://localhost:8080/api/trading/analyze/KRW-BTC

# Imbalance 이력 확인
curl http://localhost:8080/api/trading/analyze/KRW-BTC?history=true
```

---

## 리스크 관리

### 내장 리스크 관리

| 기능 | 설명 |
|------|------|
| **시장 상태 체크** | 스프레드/유동성 확인 후 주문 |
| **최대 포지션 수** | 1개로 제한 (과매매 방지) |
| **서킷브레이커** | 연속 손실 시 자동 거래 중단 |
| **불균형 이력 보관** | 최근 10회 기록 (패턴 분석) |

### 사용자 권장 사항

| 상황 | 권장 동작 |
|-------|------------|
| 유동성 낮음 (스프레드 큼) | 전략 중지 (신호 위험) |
| 뉴스/이벤트 발생 | 전략 일시 중지 |
| 급격 등락 | 대기 후 진입 (임시 안정화) |

---

## 엣지케이스 대응

### 1. 가짓 신호 (Fakeout)

- **문제:** Imbalance +0.5 발생 후 금방 -0.8로 반전
- **대응:**
  1. 연속 3회 확인 (중복 차단)
  2. 불균형 이력 보관 (패턴 감지)
  3. 가격 변동 확인 (0.3% 이상 이동)

### 2. 호가창 폭이 넓음

- **문제:** 매수/매도 호가 차이 5% 이상 → 스프레드 큼
- **대응:** 시장 상태 체크 후 진입 차단

### 3. 급격 등락 (Gap Up/Down)

- **문제:** 1분 간 5% 이상 급등 → Imbalance 변폭 큼
- **대응:** 쿨다운(Cooldown) 적용 (10분 대기)

### 4. 동시 마켓 불균형

- **문제:** BTC 상승(BUY), ETH 하락(SELL) 동시 발생
- **대응:** 각 마켓 독립 분석 (포트폴리오 제한)

---

## 기술적 분석

### 호가창(Order Book) 구조

| 호가 등급 | 설명 | 특성 |
|----------|------|------|
| 상위 1호가 | 가장 가까운 가격/수량 | 유동성 가장 높음 |
| 상위 5호가 | 상위 호가 모두 | 거래량 많음 |
| 깊이(Depth) | 호가창 전체 개수 | 깊을수록 유동성 낮음 |

### 가격 예측 로직

| 패턴 | 매수량 > 매도량 | 매수량 < 매도량 |
|------|------------------|------------------|
| 호가창 하단 압력 | 매수 우위 | - |
| 호가창 상단 압력 | - | 매도 우위 |
| 예측 방향 | 가격 상승 | 가격 하락 |

---

## API 엔드포인트

| Method | Endpoint | 설명 |
|--------|-----------|------|
| GET | `/api/trading/status` | 전체 트레이딩 상태 |
| GET | `/api/trading/analyze/{market}` | 특정 마켓 분석 |
| GET | `/api/trading/analyze/{market}?history=true` | 불균형 이력 포함 |

---

## 성과 지표

### 효율 척도

| 지표 | 값 | 설명 |
|------|-----|------|
| 승률 | 60-70% | 호가창 기반 예측 승률 |
| 평균 수익률 | 0.3-0.8% | 1회 거래 평균 수익률 |
| 평균 보유 시간 | 10-30분 | 포지션 보유 시간 (초단기) |

---

## 요약

### 장점

- ✅ 초단기 반응 (1분 분석)
- ✅ 시장 심리 반영 (매수/매도 압력)
- ✅ 추가 지표 불필요 (호가창만 있으면 됨)
- ✅ 연속 확인으로 가짓 신호 방지

### 단점

- ❌ 수수료/슬리피지 부담 (빈번 거래)
- ❌ 호가창 폭 큼 시 오신호
- ❌ 급격 등락 시 실패 (신호 전환 느림)
- ❌ 단기 노이즈 취약 (짧은 시간 변동)

### 적합한 시장

| 시장 상황 | 적합도 |
|-----------|--------|
| 유동성 높은 횡보장 | ⭐⭐⭐⭐⭐ 매우 적합 |
| 유동성 중간 횡보장 | ⭐⭐⭐⭐⭐ 적합 |
| 유동성 낮음 | ⭐⭐⭐ 불가능 (신호 위험) |
| 급격 등락 | ⭐⭐⭐ 부적합 (신호 전환 느림) |

---

*마지막 업데이트: 2026-02-08*
