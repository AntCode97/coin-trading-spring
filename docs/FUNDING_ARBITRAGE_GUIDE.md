# Funding Rate Arbitrage (펀딩 차익거래) 가이드

## 개요

델타 뉴트럴 포지션을 통해 바이낸스 선물 펀딩 비율 수익을 수취하는 전략입니다.

**핵심 아이디어:**
- 빗썸 현물: 비트코인 매수 (Long)
- 바이낸스 선물: 비트코인 공매도 (Short)
- 두 포지션 상쇄 → 가격 변동 영향 최소화
- 펀딩 비율 수수료 수령 → 주요 수익원

---

## 선물(Futures)이란?

### 오해 vs 진실

| 오해 | 진실 |
|------|------|
| "돈 빌려서 파는 거니까 빚?" | 아님. "계약"이지 대출 아님 |
| "청산되면 빚 생김?" | 아님. 담보(마진)까지만 소멸, 빚 안 남음 |
| "나중에 추가 돈 지불해야 함?" | 아님. 최악의 경우 담보만 잃음 |

### 실제 구조

```
나: USDT를 마진으로 예치 (담보)
    ↓
바이낸스: 계약 체결 (BTC 공매도 포지션 생성)
    ↓
가격 변동 → 손익은 USDT 마진에서 차감/추가
    ↓
청산 시 → 마진 0원으로 소멸 (빚 없음)
```

### 계약 vs 대출

| 구분 | 계약 (선물) | 대출 |
|------|------------|------|
| 자산 소유 | 없음 (권리만) | 있음 (자산이 내 것) |
| 담보 필요 | 있음 (USDT 마진) | 없음 (신용 기반) |
| 빚 발생 | 청산 시 마진 소멸 (빚 0) | 청산 시 빚 발생 |
| 추가 지불 | 없음 | 있음 (이자+원금) |

---

## 펀딩 차익거래(Funding Rate Arbitrage) 시스템

### 시스템 구조

```
┌─────────────────────────────────────────────────────────────┐
│               Funding Arbitrage System                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   [빗썸 현물]               [바이낸스 선물]           │
│   ┌───────────┐             ┌───────────┐              │
│   │ BTC Long  │             │ BTC Short │              │
│   │  (보유)   │             │ (공매도)  │              │
│   └───────────┘             └───────────┘              │
│         │                         │                     │
│         └─────────────┬───────────┘                     │
│                       ▼                               │
│              델타 뉴트럴                           │
│            (가격 변동 상쇄)                          │
│                                                             │
│   [수익원] 펀딩 비율 수수료 (8시간마다)                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 작동 방식

#### 1. 포지션 진입 (펀딩 비율 > 15% 연환산)

| 거래소 | 동작 | 자금 |
|-------|------|------|
| 빗썸 | 비트코인 매수 (현물 Long) | KRW 사용 |
| 바이낸스 | 비트코인 공매도 (선물 Short) | USDT 마진 담보 |

**예시 (100만원 투자):**
```
빗썸: KRW 100만원 → BTC 0.003개 매수 (현물 보유)
바이낸스: USDT 100만원 상당 → BTC 0.003개 공매도 (마진 예치)
```

#### 2. 펀딩 수수료 수령 (8시간마다)

- 바이낸스에서 펀딩 비율 수수료 수령
- **델타 뉴트럴이라 가격 변동으로는 수익/손실 상쇄됨**

#### 3. 포지션 청산

| 조건 | 행동 |
|------|------|
| 펀딩 비율 반전 (높음 → 낮음) | 자동 청산 |
| 최대 보유 기간 도달 (72시간) | 자동 청산 |
| 델타 불균형 감지 (5% 이상) | Slack 알림 |

청산 시:
- 빗썸: 비트코인 매도 (현물 담기)
- 바이낸스: 선물 포지션 닫기 (공매도 해제)

---

## 수익 구조

### 델타 뉴트럴 효과

| BTC 가격 변동 | 빗썸 현물 | 바이낸스 선물 | 총 수익 |
|-------------|-----------|--------------|--------|
| +10% | +10% 수익 | -10% 손실 | ~0% |
| -10% | -10% 손실 | +10% 수익 | ~0% |
| +15% | +15% 수익 | -13% 손실 | +2% |
| -15% | -15% 손실 | +13% 수익 | -2% |

**결과:** 가격 변동으로는 수익/손실 거의 상쇄됨

### 수익원 분석

| 항목 | 설명 | 비중 |
|------|------|------|
| 펀딩 수수료 수령 | 8시간마다 수령 (메인 수익원) | 80~90% |
| 가격 변동 손익 | 델타 불균형으로만 발생 | 10~20% |

---

## 리스크 관리

### 청산(Liquidation) 조건

#### 현재 설정 (안전 최우선)

| 설정 | 값 | 의미 |
|------|-----|------|
| 레버리지 | **1x** | 가격 변동 100%일 때 청산 |
| 마진 경고 | 50% | 미리 알림 (Slack) |
| 마진 청산 | 30% | 자동 청산 |
| 슬리피지 버퍼 | 0.2% | 주문 시 슬리피지 차단 |

#### 청산 시 결과

| 항목 | 결과 |
|------|------|
| USDT 마진 | 0원 됨 (소멸) |
| 빚 발생 | **없음** (무한 손실 방지) |
| 빗썸 현물 BTC | 그대로 존재 (영향 없음) |

### 실제 청산 확률

**델타 뉴트럴 덕분에:**
```
BTC 급등: 빗썸 현물 +10% 수익, 바이낸스 선물 -10% 손실 = 델타 0
BTC 급락: 빗썸 현물 -10% 손실, 바이낸스 선물 +10% 수익 = 델타 0
```

**결과:**
- 가격 변동으로는 수익/손실 거의 상쇄
- **청산 위험 거의 0%** (이론상 0%)
- 청산은 극단적인 상황(펀딩 비율 급락+가격 급락)에서만 발생

### 포지션 리콘실리에이션

**주기:** 5분마다 자동 실행

**기능:**
- DB 포지션 vs 실제 거래소 포지션 비교
- 현물 수량 불일치 5% 이상 → Slack 알림
- 델타 불균형 감지 → 자동 청산 권장

### 서킷 브레이커

연속 3회 실패 시 자동 거래 중단 (1시간)

---

## 바이낸스 API 키 발급 방법

### 1. API Key 발급

1. 바이낸스 계정 로그인
2. **API Management** 이동
3. **Create API** 클릭
4. 다음 설정:
   - **API Key 이름:** (자유롭게)
   - **권한:**
     - ✅ **Futures** 활성화
     - ❌ 현물/출금 비활성화 (보안 권장)
5. **API Key**와 **Secret Key** 저장 (Secret Key는 다시 볼 수 없음!)

### 2. .env 파일 설정

```bash
# 프로젝트 루트 .env 파일
BINANCE_FUTURES_API_KEY=your_api_key_here
BINANCE_FUTURES_SECRET_KEY=your_secret_key_here
```

### 3. .env 파일 보안

**⚠️ 중요:** .env 파일은 **절대 Git에 커밋하지 말 것**

```bash
# .gitignore (이미 설정됨)
.env
.env.local
```

---

## 간단 사용법

### 1. 시스템 시작

```bash
# 로컬 개발 환경
./gradlew :coin-trading-server:bootRun
```

### 2. 모니터링 (실거래 없음)

**설정:**
```yaml
# application.yml
funding:
  enabled: true
  autoTradingEnabled: false  # 실거래 비활성화
```

**동작:**
- 펀딩 비율 모니터링
- 포지션 리콘실리에이션
- 리스크 체크
- 주문 실행 안 함 (로그만 출력)

### 3. 실거래 시작 (API 키 필요)

**1단계: 모의 테스트**
```yaml
funding:
  enabled: true
  autoTradingEnabled: true
  maxSinglePositionKrw: 50000  # 5만원으로 테스트
```

**2단계: 본격 운영**
```yaml
funding:
  enabled: true
  autoTradingEnabled: true
  maxSinglePositionKrw: 1000000  # 100만원
```

### 4. 상태 확인

```bash
# 전체 상태
curl http://localhost:8080/api/funding/status

# 펀딩 기회 스캔
curl http://localhost:8080/api/funding/opportunities

# 열린 포지션
curl http://localhost:8080/api/funding/positions?status=OPEN
```

### 5. 수동 청산

```bash
curl -X POST http://localhost:8080/api/funding/positions/{id}/close
```

---

## 자금 준비

### 필요 자산

| 거래소 | 필요 자산 | 용도 |
|-------|----------|------|
| 빗썸 | KRW | 현물 비트코인 매수용 |
| 바이낸스 | USDT | 선물 마진 담보용 |

**예시 (100만원 투자):**
- 빗썸: KRW 100만원 → BTC 매수
- 바이낸스: USDT 100만원 상당 → 마진 예치

**중요:**
- 빗썸에서 **비트코인이 있어야 함** (매수해서)
- 바이낸스에서는 **USDT만 있으면 됨** (마진 담보)

---

## 청산 시나리오

### 마진 콜(Margin Call)

**발생 시:** 가격이 예상과 크게 반대로 움직일 때

1. **마진 경고** (50%): Slack 알림 → 수동 청산 권장
2. **마진 청산** (30%): 자동 청산 (USDT 마진 소진)

**이때 추가 자금 필요?**
- **필요 없음**
- 청산되면 계약 종료
- **빚이 남지 않음**

---

## 요약

### 선물 vs 대출

| 구분 | 선물 (계약) | 대출 |
|------|------------|------|
| 담보 필요 | 있음 (USDT 마진) | 없음 (신용 기반) |
| 빚 발생 | 청산 시 마진 소멸 (빚 0) | 청산 시 빚 발생 |
| 추가 지불 | 없음 | 있음 (이자+원금) |

### 걱정하신 3가지 답변

| 질문 | 답변 |
|------|------|
| 내 잔고만 청산? | 네, USDT 마진만 청산됨 (빗썸 현물은 그대로) |
| 0원 밑으로 내려가? | 아니요, 0원에서 멈춤 (빚 발생 안 함) |
| 나중에 추가 돈 지불? | 아니요, 최악의 경우 USDT 마진만 날아감 |

### 실제 위험

**유일한 리스크:** 델타 불균형 (가격 변동으로 빗썸/바이낸스 수익/손실이 완전 상쇄되지 않을 때)

**대응:**
- 5분 주기 리콘실리에이션 자동 감시
- 델타 불균형 5% 이상 시 Slack 알림
- 자동 청산 권장

---

## 더 알아보기

### 관련 파일

| 파일 | 설명 |
|------|------|
| `FundingRateArbitrageEngine.kt` | 메인 엔진 (모니터링+진입+청산) |
| `FundingPositionManager.kt` | 포지션 관리 (실제 주문+리스크 체크) |
| `FundingRiskChecker.kt` | 리스크 감지 (델타 불균형+마진 체크) |
| `FundingArbitrageProperties.kt` | 설정 (수익률 기준, 포지션 크기) |

### API 문서

- 바이낸스 Futures API: https://binance-docs.github.io/apidocs/futures/en/
- 빗썸 Private API: https://apidocs.bithumb.com/

---

*마지막 업데이트: 2026-02-08*
