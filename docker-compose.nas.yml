# NAS용 Docker Compose
# React Frontend (nginx) + Spring Boot Backend 분리 실행

services:
  # ===========================================
  # React Frontend (nginx)
  # ===========================================
  coin-trading-frontend:
    image: dbswns97/coin-trading-frontend:latest
    container_name: coin-trading-frontend
    ports:
      - "1104:80"  # 1104 포트에서 접근
    environment:
      - TZ=Asia/Seoul
    restart: unless-stopped
    # Watchtower로 자동 업데이트
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    depends_on:
      - coin-trading-backend

  # ===========================================
  # Spring Boot Backend
  # ===========================================
  coin-trading-backend:
    image: dbswns97/coin-trading-server:latest
    container_name: coin-trading-server
    # 내부 통신용으로만 8080 노출 (외부에서 직접 접근 불가)
    expose:
      - "8080"
    env_file:
      - .env
    environment:
      - TZ=Asia/Seoul
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Watchtower로 자동 업데이트
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ===========================================
  # Watchtower: Docker 이미지 자동 업데이트
  # ===========================================
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=300  # 5분마다 체크
      - WATCHTOWER_LABEL_ENABLE=true    # 라벨 있는 컨테이너만 모니터링
      - TZ=Asia/Seoul
    restart: unless-stopped

networks:
  default:
    name: coin-trading-network
