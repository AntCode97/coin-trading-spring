# NAS용 Docker Compose
# 이미 빌드된 이미지를 Docker Hub에서 pull해서 사용
# Watchtower로 자동 업데이트 지원

services:
  coin-trading:
    image: dbswns97/coin-trading-server:latest
    container_name: coin-trading-server
    ports:
      - "8080:8080"
    env_file:
      - .env
    environment:
      - TZ=Asia/Seoul
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Watchtower로 자동 업데이트 대상 표시
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # Watchtower: Docker 이미지 자동 업데이트 도구
  # - Docker Hub에 새 이미지가 푸시되면 자동으로 컨테이너 갱신
  # - 5분마다 체크하여 latest 태그 변경 감지
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=300  # 5분마다 체크
      - WATCHTOWER_LABEL_ENABLE=true    # 라벨 있는 컨테이너만 모니터링
      - TZ=Asia/Seoul
    restart: unless-stopped

networks:
  default:
    name: coin-trading-network
