server:
  port: 8080

spring:
  application:
    name: coin-trading-server
  main:
    banner-mode: off
    keep-alive: true  # Virtual Thread 사용 시 JVM 유지

  # Virtual Thread 활성화 (Java 21+)
  threads:
    virtual:
      enabled: true

  # Google GenAI만 비활성화 (project-id 필수 문제)
  autoconfigure:
    exclude:
      - org.springframework.ai.autoconfigure.chat.model.googlegenai.GoogleGenAiChatAutoConfiguration

  # MySQL 설정
  datasource:
    url: ${MYSQL_URL:jdbc:mysql://localhost:3306/coin_trading}
    username: ${MYSQL_USER:root}
    password: ${MYSQL_PASSWORD:}
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      maximum-pool-size: 10
      minimum-idle: 2
      connection-timeout: 30000

  jpa:
    hibernate:
      ddl-auto: update
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQLDialect
        format_sql: true
    open-in-view: false

  # Spring AI 설정 (OpenAI 전용)
  ai:
    # OpenAI GPT (환경변수 SPRING_AI_OPENAI_API_KEY 필요)
    # GPT-5 시리즈는 max-tokens 대신 max-completion-tokens 사용
    openai:
      api-key: ${SPRING_AI_OPENAI_API_KEY:}
      chat:
        options:
          model: gpt-5.1-codex-mini
#          max-completion-tokens: 4096
          temperature: 1

    # Google Gemini (현재 비활성화 - project-id 필수 문제)
    # google:
    #   genai:
    #     api-key: ${SPRING_AI_GOOGLE_API_KEY:}
    #     chat:
    #       options:
    #         model: gemini-3-flash-preview
    #         temperature: 0.3
    #         max-output-tokens: 4096

    # MCP Server 설정 (Stateless HTTP)
    mcp:
      server:
        enabled: true
        protocol: STATELESS
        name: coin-trading-mcp
        version: 1.0.0
        type: SYNC
        request-timeout: 30s
        instructions: |
          암호화폐 자동 매매 서버 MCP API.
          Tools: 시장 데이터, 기술적 분석, 거래 실행, 전략 관리, 성과 분석
        stateless:
          mcp-endpoint: /mcp

  # Thymeleaf 캐시 비활성화 (개발 중 템플릿 즉시 반영)
  thymeleaf:
    cache: false

# Bithumb API 설정
bithumb:
  base-url: https://api.bithumb.com
  access-key: ${BITHUMB_ACCESS_KEY:}
  secret-key: ${BITHUMB_SECRET_KEY:}
  websocket:
    enabled: ${BITHUMB_WS_ENABLED:true}
    url: ${BITHUMB_WS_URL:wss://ws-api.bithumb.com/websocket/v1}
    reconnect-delay-ms: ${BITHUMB_WS_RECONNECT_DELAY_MS:5000}
    stale-threshold-ms: ${BITHUMB_WS_STALE_THRESHOLD_MS:15000}
    max-codes-per-subscribe: ${BITHUMB_WS_MAX_CODES_PER_SUBSCRIBE:70}

# Slack Bot 알림 설정
slack:
  token: ${SLACK_TOKEN:}
  channel: ${SLACK_CHANNEL:coin-bot-alert}
  webhook-url: ${SLACK_WEBHOOK_URL:}

# 자동 거래 설정
trading:
  enabled: true  # 실거래 활성화 (필요시 false로 변경)
  markets:
    - KRW-BTC
    - KRW-ETH
    - KRW-XRP
    - KRW-SOL
  order-amount-krw: 10000
  max-drawdown-percent: ${MAX_DRAWDOWN_PERCENT:10.0}
  risk-per-trade-percent: ${RISK_PER_TRADE_PERCENT:1.0}
  risk-throttle:
    enabled: ${RISK_THROTTLE_ENABLED:true}
    lookback-trades: ${RISK_THROTTLE_LOOKBACK_TRADES:30}
    min-closed-trades: ${RISK_THROTTLE_MIN_CLOSED_TRADES:8}
    weak-win-rate: ${RISK_THROTTLE_WEAK_WIN_RATE:0.45}
    weak-avg-pnl-percent: ${RISK_THROTTLE_WEAK_AVG_PNL_PERCENT:-0.2}
    weak-multiplier: ${RISK_THROTTLE_WEAK_MULTIPLIER:0.70}
    critical-win-rate: ${RISK_THROTTLE_CRITICAL_WIN_RATE:0.35}
    critical-avg-pnl-percent: ${RISK_THROTTLE_CRITICAL_AVG_PNL_PERCENT:-0.8}
    critical-consecutive-losses: ${RISK_THROTTLE_CRITICAL_CONSECUTIVE_LOSSES:4}
    critical-multiplier: ${RISK_THROTTLE_CRITICAL_MULTIPLIER:0.45}
    block-new-buys-on-critical: ${RISK_THROTTLE_BLOCK_NEW_BUYS_ON_CRITICAL:true}
    block-multiplier-threshold: ${RISK_THROTTLE_BLOCK_MULTIPLIER_THRESHOLD:0.50}
    min-buy-confidence-normal: ${RISK_THROTTLE_MIN_BUY_CONFIDENCE_NORMAL:55.0}
    min-buy-confidence-weak: ${RISK_THROTTLE_MIN_BUY_CONFIDENCE_WEAK:65.0}
    min-buy-confidence-critical: ${RISK_THROTTLE_MIN_BUY_CONFIDENCE_CRITICAL:75.0}
    cache-minutes: ${RISK_THROTTLE_CACHE_MINUTES:10}
  close-recovery:
    polling-ms: ${CLOSE_RECOVERY_POLLING_MS:3000}
  strategy:
    type: ${STRATEGY_TYPE:MEAN_REVERSION} # 대폭락/고변동성 장에서는 VOLATILITY_SURVIVAL 권장
    dca-interval: ${DCA_INTERVAL:86400000}
    dca-take-profit-percent: ${DCA_TAKE_PROFIT_PERCENT:5.0}
    dca-stop-loss-percent: ${DCA_STOP_LOSS_PERCENT:-3.0}
    grid-levels: ${GRID_LEVELS:5}
    grid-spacing-percent: ${GRID_SPACING_PERCENT:1.0}
    # Mean Reversion 최적화: 1.2로 완화 (기존 2.0)
    mean-reversion-threshold: ${MEAN_REVERSION_THRESHOLD:1.2}
    # RSI 범위 확대: 25-75 (기존 30-70)
    rsi-oversold: ${RSI_OVERSOLD:25}
    rsi-overbought: ${RSI_OVERBOUGHT:75}
    bollinger-period: ${BOLLINGER_PERIOD:20}
    # 볼린저 밴드 민감도 상향: 1.8 (기존 2.0)
    bollinger-std-dev: ${BOLLINGER_STD_DEV:1.8}

# LLM 최적화 설정
llm:
  optimizer:
    enabled: true  # LLM 최적화 활성화
    cron: 0 0 0 * * *  # 매일 자정
    validation:
      enabled: ${LLM_OPT_VALIDATION_ENABLED:true}
      market: ${LLM_OPT_VALIDATION_MARKET:KRW-BTC}
      cache-minutes: ${LLM_OPT_VALIDATION_CACHE_MINUTES:180}
      min-valid-windows: ${LLM_OPT_MIN_VALID_WINDOWS:6}
      min-out-of-sample-sharpe: ${LLM_OPT_MIN_OOS_SHARPE:0.5}
      min-out-of-sample-trades: ${LLM_OPT_MIN_OOS_TRADES:1.0}
      max-sharpe-decay-percent: ${LLM_OPT_MAX_SHARPE_DECAY:35.0}
      max-out-of-sample-drawdown-percent: ${LLM_OPT_MAX_OOS_DRAWDOWN:25.0}
      execution-slippage-bps: ${LLM_OPT_EXECUTION_SLIPPAGE_BPS:8.0}

# Logging 설정
logging:
  level:
    root: INFO
    com.ant.cointrading: DEBUG
    org.springframework.ai: INFO
    org.springframework.data.jpa: WARN
  pattern:
    console: "%d{HH:mm:ss} [%thread] %-5level %logger{20} - %msg%n"

# Volume Surge 전략 설정 (거래량 급등 단타 - 모멘텀 기반)
# Jim Simons 최적화: 수수료 고려, 익절 낮춤, 작은 수익 자주 반복
volumesurge:
  enabled: true  # Volume Surge 활성화
  polling-interval-ms: ${VOLUME_SURGE_POLLING_MS:30000}
  position-size-krw: ${VOLUME_SURGE_POSITION_SIZE:10000}
  max-positions: ${VOLUME_SURGE_MAX_POSITIONS:5}
  stop-loss-percent: ${VOLUME_SURGE_STOP_LOSS:-1.5}
  take-profit-percent: ${VOLUME_SURGE_TAKE_PROFIT:4.0}
  trailing-stop-trigger: ${VOLUME_SURGE_TRAILING_TRIGGER:1.5}
  trailing-stop-offset: ${VOLUME_SURGE_TRAILING_OFFSET:0.8}
  position-timeout-min: ${VOLUME_SURGE_TIMEOUT_MIN:60}
  llm-filter-enabled: ${VOLUME_SURGE_LLM_FILTER:true}
  reflection-cron: ${VOLUME_SURGE_REFLECTION_CRON:0 0 1 * * *}
  # 쿨다운 완화: 5분 → 3분
  cooldown-min: ${VOLUME_SURGE_COOLDOWN_MIN:3}
  # LLM 쿨다운 완화: 240분 → 60분 (더 자주 재평가)
  llm-cooldown-min: ${VOLUME_SURGE_LLM_COOLDOWN_MIN:60}
  max-consecutive-losses: ${VOLUME_SURGE_MAX_LOSSES:5}
  daily-max-loss-krw: ${VOLUME_SURGE_DAILY_MAX_LOSS:50000}
  # 진입 조건 완화 (모멘텀 전략)
  min-confluence-score: ${VOLUME_SURGE_MIN_CONFLUENCE:30}
  max-rsi: ${VOLUME_SURGE_MAX_RSI:80}
  min-volume-ratio: ${VOLUME_SURGE_MIN_VOLUME_RATIO:1.3}
  # 경보 신선도 완화: 5분 → 10분
  alert-freshness-min: ${VOLUME_SURGE_ALERT_FRESHNESS:10}

# Breakout 전략 설정 (볼린저 밴드 돌파)
breakout:
  enabled: ${BREAKOUT_ENABLED:false}  # 백테스팅 후 활성화
  position-size-krw: ${BREAKOUT_POSITION_SIZE:10000}
  bollinger-period: ${BREAKOUT_BB_PERIOD:50}
  bollinger-std-dev: ${BREAKOUT_BB_STD_DEV:2.0}
  min-breakout-volume-ratio: ${BREAKOUT_MIN_VOLUME_RATIO:1.5}
  stop-loss-percent: ${BREAKOUT_STOP_LOSS:-2.0}
  take-profit-percent: ${BREAKOUT_TAKE_PROFIT:8.0}
  trailing-stop-trigger: ${BREAKOUT_TRAILING_TRIGGER:3.0}
  trailing-stop-offset: ${BREAKOUT_TRAILING_OFFSET:1.0}
  cooldown-minutes: ${BREAKOUT_COOLDOWN:60}

# Volatility Survival 전략 설정 (패닉 반등 선별 + 생존형 리스크 관리)
volatility-survival:
  enabled: ${VOLATILITY_SURVIVAL_ENABLED:true}
  min-candles: ${VOLATILITY_SURVIVAL_MIN_CANDLES:50}
  rsi-period: ${VOLATILITY_SURVIVAL_RSI_PERIOD:14}
  rsi-entry-threshold: ${VOLATILITY_SURVIVAL_RSI_ENTRY:33.0}
  rsi-exit-threshold: ${VOLATILITY_SURVIVAL_RSI_EXIT:67.0}
  ema-fast-period: ${VOLATILITY_SURVIVAL_EMA_FAST:7}
  ema-slow-period: ${VOLATILITY_SURVIVAL_EMA_SLOW:21}
  bollinger-period: ${VOLATILITY_SURVIVAL_BB_PERIOD:20}
  bollinger-std-dev: ${VOLATILITY_SURVIVAL_BB_STD:2.2}
  volume-period: ${VOLATILITY_SURVIVAL_VOLUME_PERIOD:20}
  min-volume-ratio: ${VOLATILITY_SURVIVAL_MIN_VOLUME:1.4}
  min-atr-percent: ${VOLATILITY_SURVIVAL_MIN_ATR:1.8}
  panic-lookback-candles: ${VOLATILITY_SURVIVAL_LOOKBACK:8}
  min-panic-drop-percent: ${VOLATILITY_SURVIVAL_MIN_DROP:2.0}
  min-rebound-percent: ${VOLATILITY_SURVIVAL_MIN_REBOUND:0.7}
  lower-band-tolerance-percent: ${VOLATILITY_SURVIVAL_BAND_TOLERANCE:1.0}
  stop-loss-percent: ${VOLATILITY_SURVIVAL_STOP_LOSS:2.2}
  take-profit-percent: ${VOLATILITY_SURVIVAL_TAKE_PROFIT:3.8}
  trailing-activation-percent: ${VOLATILITY_SURVIVAL_TRAIL_ACT:1.2}
  trailing-offset-percent: ${VOLATILITY_SURVIVAL_TRAIL_OFFSET:1.1}
  max-holding-minutes: ${VOLATILITY_SURVIVAL_MAX_HOLDING_MIN:240}
  stop-loss-cooldown-minutes: ${VOLATILITY_SURVIVAL_COOLDOWN_MIN:45}

# Meme Scalper 전략 설정 (세력 코인 초단타 - 펌프앤덤프 스캘핑)
# Jim Simons 최적화: 수수료 고려, 익절 낮춤, 작은 수익 자주 반복
memescalper:
  enabled: ${MEME_SCALPER_ENABLED:true}
  polling-interval-ms: ${MEME_SCALPER_POLLING_MS:15000}
  position-size-krw: ${MEME_SCALPER_POSITION_SIZE:10000}
  max-positions: ${MEME_SCALPER_MAX_POSITIONS:3}
  stop-loss-percent: ${MEME_SCALPER_STOP_LOSS:-1.5}
  take-profit-percent: ${MEME_SCALPER_TAKE_PROFIT:2.5}
  position-timeout-min: ${MEME_SCALPER_TIMEOUT_MIN:20}
  trailing-stop-trigger: ${MEME_SCALPER_TRAILING_TRIGGER:1.5}
  trailing-stop-offset: ${MEME_SCALPER_TRAILING_OFFSET:0.5}
  # 펌프 감지 조건
  volume-spike-ratio: ${MEME_SCALPER_VOLUME_SPIKE:5.0}
  price-spike-percent: ${MEME_SCALPER_PRICE_SPIKE:3.0}
  min-bid-imbalance: ${MEME_SCALPER_MIN_IMBALANCE:0.3}
  max-rsi: ${MEME_SCALPER_MAX_RSI:80}
  # 웹소켓 기반 선제 후보 추출 (경보제 의존 제거)
  use-websocket-feed: ${MEME_SCALPER_USE_WS_FEED:true}
  websocket-candidate-limit: ${MEME_SCALPER_WS_CANDIDATE_LIMIT:40}
  websocket-min-notional-10s-krw: ${MEME_SCALPER_WS_MIN_NOTIONAL_10S:30000000}
  websocket-min-price-spike-percent: ${MEME_SCALPER_WS_MIN_PRICE_SPIKE:0.4}
  websocket-min-notional-spike-ratio: ${MEME_SCALPER_WS_MIN_NOTIONAL_SPIKE:1.8}
  websocket-min-bid-imbalance: ${MEME_SCALPER_WS_MIN_IMBALANCE:0.05}
  websocket-max-spread-percent: ${MEME_SCALPER_WS_MAX_SPREAD:0.5}
  # 청산 신호
  volume-drop-ratio: ${MEME_SCALPER_VOLUME_DROP:0.3}
  imbalance-exit-threshold: ${MEME_SCALPER_IMBALANCE_EXIT:0.0}
  # 리스크 관리
  cooldown-sec: ${MEME_SCALPER_COOLDOWN_SEC:60}
  max-consecutive-losses: ${MEME_SCALPER_MAX_LOSSES:3}
  daily-max-loss-krw: ${MEME_SCALPER_DAILY_MAX_LOSS:20000}
  daily-max-trades: ${MEME_SCALPER_DAILY_MAX_TRADES:50}
  # 필터 (대형 코인 제외 - 시가총액 상위)
  exclude-markets:
    - KRW-BTC
    - KRW-ETH
    - KRW-XRP
    - KRW-SOL
    - KRW-ADA
    - KRW-DOGE
    - KRW-DOT
    - KRW-MATIC
    - KRW-ETC
    - KRW-LTC
    - KRW-BCH
    - KRW-LINK
    - KRW-AVAX
    - KRW-TRX
    - KRW-SHIB
    - KRW-ATOM
    - KRW-EOS
    - KRW-XLM
    - KRW-HBAR
    - KRW-VET
    - KRW-BSV
    - KRW-XMR
    - KRW-NEO
    - KRW-KLAY
  min-trading-value-krw: ${MEME_SCALPER_MIN_TRADING_VALUE:1000000000}  # 10억 (저유동성 잡코인 제외)
  max-trading-value-krw: ${MEME_SCALPER_MAX_TRADING_VALUE:50000000000}

# Active Position Manager (능동적 포지션 관리 - TP/SL 동적 조정)
active-position-manager:
  enabled: true
  volume-surge:
    analyze-interval-seconds: 60
    regime-shift-exit: true
    break-even-trigger: 1.0
    profit-lock-trigger: 3.0
    profit-lock-min: 1.0
    confluence-degradation: 30
    divergence-stop-tighten: 0.5
  meme-scalper:
    analyze-interval-seconds: 30
    regime-shift-exit: false
    break-even-trigger: 0.5
    profit-lock-trigger: 1.5
    profit-lock-min: 0.3
    confluence-degradation: 20
    divergence-stop-tighten: 0.3
  dca:
    analyze-interval-seconds: 300
    regime-shift-exit: true
    break-even-trigger: 3.0
    profit-lock-trigger: 8.0
    profit-lock-min: 3.0
    confluence-degradation: 40
    divergence-stop-tighten: 1.0

# Actuator
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,env,conditions
  endpoint:
    health:
      show-details: always
