<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>코인 트레이딩 대시보드</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f1419;
            color: #e1e1e1;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: #fff;
            margin-bottom: 20px;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1 span.refresh {
            font-size: 12px;
            color: #888;
            font-weight: normal;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .card {
            background: #1e2329;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #2b3139;
        }

        .card-title {
            font-size: 12px;
            color: #848e9c;
            margin-bottom: 8px;
        }

        .card-value {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
        }

        .card-value.positive { color: #0ecb81; }
        .card-value.negative { color: #f6465d; }

        .section {
            background: #1e2329;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #2b3139;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #2b3139;
        }

        .positions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .positions-table th,
        .positions-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #2b3139;
        }

        .positions-table th {
            color: #848e9c;
            font-size: 12px;
            font-weight: normal;
        }

        .positions-table td {
            color: #e1e1e1;
            font-size: 14px;
        }

        .positions-table tr:hover {
            background: #2b3139;
        }

        .positive { color: #0ecb81; }
        .negative { color: #f6465d; }
        .neutral { color: #e1e1e1; }

        .strategy-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .strategy-meme { background: #f6465d20; color: #f6465d; }
        .strategy-volume { background: #0ecb8120; color: #0ecb81; }
        .strategy-dca { background: #3b82f620; color: #3b82f6; }

        .exit-reason {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        .exit-profit { background: #0ecb8120; color: #0ecb81; }
        .exit-loss { background: #f6465d20; color: #f6465d; }
        .exit-other { background: #848e9c20; color: #848e9c; }

        .tooltip-cell {
            cursor: help;
            border-bottom: 1px dotted #848e9c;
        }

        .sell-btn {
            background: #f6465d;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .sell-btn:hover {
            background: #d63d56;
        }

        .sell-btn:active {
            background: #b03547;
        }

        .date-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-nav-btn {
            background: #2b3139;
            color: #e1e1e1;
            border: 1px solid #3d4650;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .date-nav-btn:hover:not(:disabled) {
            background: #3d4650;
        }

        .date-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .date-current {
            font-size: 14px;
            color: #e1e1e1;
            min-width: 100px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #848e9c;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        .engine-status {
            display: flex;
            gap: 20px;
            font-size: 12px;
        }

        .engine-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.active { background: #0ecb81; }
        .status-dot.inactive { background: #f6465d; }

        .coin-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
        }

        .coin-item {
            background: #2b3139;
            border-radius: 8px;
            padding: 15px;
        }

        .coin-symbol {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }

        .coin-detail {
            font-size: 12px;
            color: #848e9c;
            margin-bottom: 4px;
        }

        .coin-detail span {
            color: #e1e1e1;
        }

        .no-positions {
            text-align: center;
            padding: 40px;
            color: #848e9c;
            font-size: 14px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .live-indicator {
            animation: pulse 2s infinite;
        }

        /* ===== 모바일 반응형 ===== */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            h1 {
                font-size: 20px;
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            h1 span.refresh {
                font-size: 11px;
            }

            /* 요약 카드 2열로 */
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-bottom: 20px;
            }

            .card {
                padding: 15px;
                border-radius: 10px;
            }

            .card-title {
                font-size: 11px;
            }

            .card-value {
                font-size: 18px;
            }

            /* 섹션 패딩 감소 */
            .section {
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 15px;
            }

            .section-title {
                font-size: 14px;
                margin-bottom: 12px;
            }

            /* 테이블: 가로 스크롤 */
            .positions-table {
                font-size: 11px;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }

            .positions-table thead,
            .positions-table tbody,
            .positions-table tr,
            .positions-table th,
            .positions-table td {
                display: block;
            }

            .positions-table thead {
                display: none;
            }

            .positions-table tr {
                margin-bottom: 15px;
                background: #1e2329;
                border-radius: 8px;
                padding: 12px;
                border: 1px solid #2b3139;
            }

            .positions-table td {
                padding: 6px 0;
                border: none;
                display: flex;
                justify-content: space-between;
                align-items: center;
                white-space: normal;
            }

            .positions-table td::before {
                content: attr(data-label);
                font-weight: 500;
                color: #848e9c;
                font-size: 11px;
            }

            /* 엔진 상태 2열로 */
            .engine-status {
                flex-direction: column;
                gap: 12px;
            }

            .engine-item {
                font-size: 12px;
            }

            /* 통계 그리드 2열로 */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-value {
                font-size: 16px;
            }

            /* 코인 리스트 1열로 */
            .coin-list {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            /* 전략 태그, 청산사유 태그 */
            .strategy-tag,
            .exit-reason {
                font-size: 10px;
                padding: 3px 6px;
            }

            /* tooltip-cell 스타일 유지 */
            .tooltip-cell {
                border-bottom: 1px dotted #848e9c;
            }
        }

        /* 소형 모바일 (아이폰 SE 등) */
        @media (max-width: 375px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }

            .card-value {
                font-size: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            트레이딩 대시보드
            <span class="refresh live-indicator">실시간 업데이트 중</span>
        </h1>

        <!-- 요약 카드 -->
        <div class="summary-cards">
            <div class="card">
                <div class="card-title">총 자산</div>
                <div class="card-value" th:text="${#numbers.formatInteger(totalAssetKrw, 1, 'COMMA')} + '원'">0원</div>
            </div>
            <div class="card">
                <div class="card-title">KRW 잔고</div>
                <div class="card-value" th:text="${#numbers.formatInteger(krwBalance, 1, 'COMMA')} + '원'">0원</div>
            </div>
            <div class="card">
                <div class="card-title">오늘 수익</div>
                <div class="card-value" th:class="${todayStats.totalPnl >= 0} ? 'positive' : 'negative'"
                     th:text="${todayStats.totalPnl >= 0 ? '+' : ''} + ${#numbers.formatInteger(todayStats.totalPnl, 1, 'COMMA')} + '원'">0원</div>
            </div>
            <div class="card">
                <div class="card-title">전체 수익</div>
                <div class="card-value" th:class="${totalStats.totalPnl >= 0} ? 'positive' : 'negative'"
                     th:text="${totalStats.totalPnl >= 0 ? '+' : ''} + ${#numbers.formatInteger(totalStats.totalPnl, 1, 'COMMA')} + '원'">0원</div>
            </div>
        </div>

        <!-- 엔진 상태 -->
        <div class="section">
            <div class="section-title">엔진 상태</div>
            <div class="engine-status">
                <div class="engine-item">
                    <div class="status-dot" th:class="${memeScalperEnabled == 'true' ? 'active' : 'inactive'}"></div>
                    <span>Meme Scalper: </span>
                    <span th:text="${memeScalperEnabled == 'true' ? '활성' : '비활성'}">비활성</span>
                    <span style="color: #848e9c; margin-left: 5px;">(포지션: <span th:text="${memeScalperOpenPositions}">0</span>)</span>
                </div>
                <div class="engine-item">
                    <div class="status-dot" th:class="${volumeSurgeEnabled == 'true' ? 'active' : 'inactive'}"></div>
                    <span>Volume Surge: </span>
                    <span th:text="${volumeSurgeEnabled == 'true' ? '활성' : '비활성'}">비활성</span>
                    <span style="color: #848e9c; margin-left: 5px;">(포지션: <span th:text="${volumeSurgeOpenPositions}">0</span>)</span>
                </div>
                <div class="engine-item">
                    <div class="status-dot" th:class="${dcaEngineEnabled == 'true' ? 'active' : 'inactive'}"></div>
                    <span>DCA Engine: </span>
                    <span th:text="${dcaEngineEnabled == 'true' ? '활성' : '비활성'}">비활성</span>
                    <span style="color: #848e9c; margin-left: 5px;">(포지션: <span th:text="${dcaEngineOpenPositions}">0</span>)</span>
                </div>
                <div class="engine-item">
                    <div class="status-dot" th:class="${tradingEngineEnabled == 'true' ? 'active' : 'inactive'}"></div>
                    <span>Trading Engine: </span>
                    <span th:text="${tradingEngineEnabled == 'true' ? '활성' : '비활성'}">비활성</span>
                    <span style="color: #848e9c; margin-left: 5px;">(마켓: <span th:text="${tradingEngineMarkets}">BTC, ETH</span>)</span>
                </div>
            </div>
        </div>

        <!-- 열린 포지션 -->
        <div class="section">
            <div class="section-title">열린 포지션</div>
            <div th:if="${#lists.isEmpty(openPositions)}" class="no-positions">
                열린 포지션이 없습니다
            </div>
            <table class="positions-table" th:if="${!#lists.isEmpty(openPositions)}">
                <thead>
                    <tr>
                        <th>마켓</th>
                        <th>전략</th>
                        <th>진입가</th>
                        <th>현재가</th>
                        <th>수량</th>
                        <th>평가금액</th>
                        <th>손익</th>
                        <th>손익률</th>
                        <th>익절가</th>
                        <th>손절가</th>
                        <th>매도</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="pos : ${openPositions}">
                        <td data-label="마켓" th:text="${pos.market}">KRW-BTC</td>
                        <td data-label="전략">
                            <span class="strategy-tag"
                                  th:class="${pos.strategy == 'Meme Scalper' ? 'strategy-meme' : (pos.strategy == 'Volume Surge' ? 'strategy-volume' : 'strategy-dca')}"
                                  th:text="${pos.strategy}">Meme Scalper</span>
                        </td>
                        <td data-label="진입가" th:text="${#numbers.formatInteger(pos.entryPrice, 1, 'COMMA')}">0</td>
                        <td data-label="현재가" th:text="${#numbers.formatInteger(pos.currentPrice, 1, 'COMMA')}">0</td>
                        <td data-label="수량" th:text="${#numbers.formatDecimal(pos.quantity, 1, 4)}">0</td>
                        <td data-label="평가금액" th:text="|${#numbers.formatInteger(pos.value, 1, 'COMMA')}원|">0원</td>
                        <td data-label="손익" th:class="${pos.pnl >= 0} ? 'positive' : 'negative'"
                            th:text="|${pos.pnl >= 0 ? '+' : ''}${#numbers.formatInteger(pos.pnl, 1, 'COMMA')}원|">0원</td>
                        <td data-label="손익률" th:class="${pos.pnlPercent >= 0} ? 'positive' : 'negative'"
                            th:text="|${pos.pnlPercent >= 0 ? '+' : ''}${#numbers.formatDecimal(pos.pnlPercent, 1, 2)}%|">0%</td>
                        <td data-label="익절가" th:text="${#numbers.formatInteger(pos.takeProfitPrice, 1, 'COMMA')}">0</td>
                        <td data-label="손절가" th:text="${#numbers.formatInteger(pos.stopLossPrice, 1, 'COMMA')}">0</td>
                        <td data-label="매도">
                            <button class="sell-btn"
                                    th:data-market="${pos.market}"
                                    th:data-strategy="${pos.strategy}"
                                    onclick="manualSell(this)">
                                매도
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 오늘 거래 내역 -->
        <div class="section">
            <div class="section-title">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>거래 내역</span>
                    <div class="date-nav">
                        <button class="date-nav-btn" onclick="changeDate(-1)" th:disabled="${currentDaysAgo == 7}">◀ 이전</button>
                        <span class="date-current" th:text="${currentDateStr}">02-01 (금)</span>
                        <button class="date-nav-btn" onclick="changeDate(1)" th:disabled="${currentDaysAgo == 0}">다음 ▶</button>
                    </div>
                </div>
            </div>
            <div th:if="${#lists.isEmpty(todayTrades)}" class="no-positions">
                해당 날짜에 체결된 거래가 없습니다
            </div>
            <table class="positions-table" th:if="${!#lists.isEmpty(todayTrades)}">
                <thead>
                    <tr>
                        <th>마켓</th>
                        <th>전략</th>
                        <th>진입가</th>
                        <th>청산가</th>
                        <th>수량</th>
                        <th>보유시간</th>
                        <th>손익</th>
                        <th>손익률</th>
                        <th>사유</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="trade : ${todayTrades}">
                        <td data-label="마켓" th:text="${trade.market}">KRW-BTC</td>
                        <td data-label="전략">
                            <span class="strategy-tag"
                                  th:class="${trade.strategy == 'Meme Scalper' ? 'strategy-meme' : (trade.strategy == 'Volume Surge' ? 'strategy-volume' : 'strategy-dca')}"
                                  th:text="${trade.strategy}">Meme Scalper</span>
                        </td>
                        <td data-label="진입가" th:text="${#numbers.formatDecimal(trade.entryPrice, 1, 0)}">0</td>
                        <td data-label="청산가" th:text="${#numbers.formatDecimal(trade.exitPrice, 1, 0)}">0</td>
                        <td data-label="수량" th:text="${#numbers.formatDecimal(trade.quantity, 1, 4)}">0</td>
                        <td data-label="보유시간" th:title="|진입: ${trade.entryTimeFormatted} / 청산: ${trade.exitTimeFormatted}|"
                            th:text="${trade.holdingMinutes} + '분'"
                            class="tooltip-cell">0분</td>
                        <td data-label="손익" th:class="${trade.pnlAmount >= 0} ? 'positive' : 'negative'"
                            th:text="|${trade.pnlAmount >= 0 ? '+' : ''}${#numbers.formatDecimal(trade.pnlAmount, 1, 0)}원|">0원</td>
                        <td data-label="손익률" th:class="${trade.pnlPercent >= 0} ? 'positive' : 'negative'"
                            th:text="|${trade.pnlPercent >= 0 ? '+' : ''}${#numbers.formatDecimal(trade.pnlPercent, 1, 2)}%|">0%</td>
                        <td data-label="사유">
                            <span class="exit-reason"
                                  th:class="${trade.exitReason == 'TAKE_PROFIT' ? 'exit-profit' : (trade.exitReason == 'STOP_LOSS' ? 'exit-loss' : 'exit-other')}"
                                  th:text="${trade.exitReason}"
                                  th:title="${exitReasonTitles[trade.exitReason]}">
                                TAKE_PROFIT
                            </span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 보유 코인 -->
        <div class="section">
            <div class="section-title">보유 코인</div>
            <div class="coin-list" th:if="${!#lists.isEmpty(coinAssets)}">
                <div class="coin-item" th:each="coin : ${coinAssets}">
                    <div class="coin-symbol" th:text="${coin.symbol}">BTC</div>
                    <div class="coin-detail">수량: <span th:text="${#numbers.formatDecimal(coin.quantity, 1, 4)}">0</span></div>
                    <div class="coin-detail">평단가: <span th:text="|${#numbers.formatInteger(coin.avgPrice, 1, 'COMMA')}원|">0원</span></div>
                    <div class="coin-detail">현재가: <span th:text="|${#numbers.formatInteger(coin.currentPrice, 1, 'COMMA')}원|">0원</span></div>
                    <div class="coin-detail">평가액: <span th:text="|${#numbers.formatInteger(coin.value, 1, 'COMMA')}원|">0원</span></div>
                    <div class="coin-detail">
                        손익: <span th:class="${coin.pnl >= 0} ? 'positive' : 'negative'"
                               th:text="|${coin.pnl >= 0 ? '+' : ''}${#numbers.formatInteger(coin.pnl, 1, 'COMMA')}원|">0원</span>
                        <span style="margin-left: 8px;" th:class="${coin.pnlPercent >= 0} ? 'positive' : 'negative'"
                              th:text="|(${coin.pnlPercent >= 0 ? '+' : ''}${#numbers.formatDecimal(coin.pnlPercent, 1, 2)}%)|">(0%)</span>
                    </div>
                </div>
            </div>
            <div class="no-positions" th:if="${#lists.isEmpty(coinAssets)}">
                보유 중인 코인이 없습니다
            </div>
        </div>

        <!-- 통계 -->
        <div class="section">
            <div class="section-title">거래 통계</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">오늘 거래</div>
                    <div class="stat-value" th:text="${todayStats.totalTrades} + '건'">0건</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">오늘 승률</div>
                    <div class="stat-value" th:text="${#numbers.formatPercent(todayStats.winRate, 1, 1)} + ' (' + ${todayStats.winCount} + '승 ' + ${todayStats.lossCount} + '패)'">0%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">전체 거래</div>
                    <div class="stat-value" th:text="${totalStats.totalTrades} + '건'">0건</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">전체 승률</div>
                    <div class="stat-value" th:text="${#numbers.formatPercent(totalStats.winRate, 1, 1)} + ' (' + ${totalStats.winCount} + '승 ' + ${totalStats.lossCount} + '패)'">0%</div>
                </div>
            </div>
        </div>

        <!-- 수동 매매 -->
        <div class="section">
            <div class="section-title">수동 매매</div>
            <div class="manual-trade">
                <div class="trade-form">
                    <div class="form-row">
                        <label>마켓:</label>
                        <select id="tradeMarket" style="flex: 1; padding: 8px; background: #2b3139; border: 1px solid #3d4650; color: #e1e1e1; border-radius: 4px;">
                            <option value="KRW-BTC">BTC</option>
                            <option value="KRW-ETH">ETH</option>
                            <option value="KRW-XRP">XRP</option>
                            <option value="KRW-SOL">SOL</option>
                            <option value="KRW-DOGE">DOGE</option>
                            <option value="KRW-ADA">ADA</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label>주문 유형:</label>
                        <select id="orderType" style="flex: 1; padding: 8px; background: #2b3139; border: 1px solid #3d4650; color: #e1e1e1; border-radius: 4px;">
                            <option value="market">시장가</option>
                            <option value="price">지정가</option>
                        </select>
                    </div>
                    <div class="form-row" id="priceRow" style="display: none;">
                        <label>가격 (KRW):</label>
                        <input type="number" id="tradePrice" placeholder="가격 입력" style="flex: 1; padding: 8px; background: #2b3139; border: 1px solid #3d4650; color: #e1e1e1; border-radius: 4px;">
                    </div>
                    <div class="form-row">
                        <label id="amountLabel">금액 (KRW):</label>
                        <input type="number" id="tradeAmount" placeholder="금액 입력" value="10000" style="flex: 1; padding: 8px; background: #2b3139; border: 1px solid #3d4650; color: #e1e1e1; border-radius: 4px;">
                    </div>
                    <div class="form-buttons">
                        <button onclick="executeBuy()" style="flex: 1; padding: 12px; background: #0ecb81; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">매수</button>
                        <button onclick="executeSell()" style="flex: 1; padding: 12px; background: #f6465d; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-left: 10px;">매도</button>
                    </div>
                    <div id="tradeResult" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;"></div>
                </div>
            </div>
        </div>

        <!-- LLM 최적화 -->
        <div class="section">
            <div class="section-title">LLM 최적화</div>
            <div class="optimizer">
                <div class="optimizer-status">
                    <div style="margin-bottom: 15px;">
                        <span style="color: #848e9c; font-size: 14px;">LLM 서비스: </span>
                        <span id="llmServiceStatus" style="margin-left: 10px;">확인 중...</span>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <span style="color: #848e9c; font-size: 14px;">마지막 최적화: </span>
                        <span id="lastOptimization" style="margin-left: 10px;">없음</span>
                    </div>
                </div>
                <button onclick="runOptimization()" style="width: 100%; padding: 12px; background: #3b82f6; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">최적화 실행</button>
                <div id="optimizationResult" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none; white-space: pre-wrap; font-size: 13px;"></div>
            </div>
        </div>

        <!-- 전략 설정 -->
        <div class="section">
            <div class="section-title">전략 & 엔진 설정</div>
            <div class="strategy-settings">
                <div class="setting-category">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="font-size: 16px; color: #fff;">Meme Scalper</h3>
                        <label class="toggle-switch">
                            <input type="checkbox" id="memeEnabled" onchange="toggleMemeScalper()">
                            <span class="slider"></span>
                            <span class="status-text" id="memeStatusText">비활성</span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <label>1회 주문 금액 (KRW)</label>
                        <input type="number" id="memePositionSize" value="6000" onchange="updateMemeSetting('positionSizeKrw', this.value)" style="padding: 6px; background: #2b3139; border: 1px solid #3d4650; color: #e1e1e1; border-radius: 4px; width: 120px;">
                        <span style="font-size: 11px; color: #848e9c; margin-left: 5px;">초단타 매수 금액</span>
                    </div>
                    <div class="setting-item">
                        <label>손절률 (%)</label>
                        <input type="number" id="memeStopLoss" value="-1.5" step="0.1" onchange="updateMemeSetting('stopLossPercent', this.value)" style="padding: 6px; background: #2b3139; border: 1px solid #3d4650; color: #e1e1e1; border-radius: 4px; width: 120px;">
                        <span style="font-size: 11px; color: #848e9c; margin-left: 5px;">마이너스 = 손절</span>
                    </div>
                    <div class="setting-item">
                        <label>익절률 (%)</label>
                        <input type="number" id="memeTakeProfit" value="3.0" step="0.1" onchange="updateMemeSetting('takeProfitPercent', this.value)" style="padding: 6px; background: #2b3139; border: 1px solid #3d4650; color: #e1e1e1; border-radius: 4px; width: 120px;">
                        <span style="font-size: 11px; color: #848e9c; margin-left: 5px;">목표 수익률</span>
                    </div>
                </div>

                <div class="setting-category">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="font-size: 16px; color: #fff;">Volume Surge</h3>
                        <label class="toggle-switch">
                            <input type="checkbox" id="volumeEnabled" onchange="toggleVolumeSurge()">
                            <span class="slider"></span>
                            <span class="status-text" id="volumeStatusText">비활성</span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <label>1회 주문 금액 (KRW)</label>
                        <input type="number" id="volumePositionSize" value="10000" onchange="updateVolumeSetting('positionSizeKrw', this.value)" style="padding: 6px; background: #2b3139; border: 1px solid #3d4650; color: #e1e1e1; border-radius: 4px; width: 120px;">
                        <span style="font-size: 11px; color: #848e9c; margin-left: 5px;">거래량 급등 매수 금액</span>
                    </div>
                    <div class="setting-item">
                        <label>손절률 (%)</label>
                        <input type="number" id="volumeStopLoss" value="-2.0" step="0.1" onchange="updateVolumeSetting('stopLossPercent', this.value)" style="padding: 6px; background: #2b3139; border: 1px solid #3d4650; color: #e1e1e1; border-radius: 4px; width: 120px;">
                        <span style="font-size: 11px; color: #848e9c; margin-left: 5px;">마이너스 = 손절</span>
                    </div>
                    <div class="setting-item">
                        <label>익절률 (%)</label>
                        <input type="number" id="volumeTakeProfit" value="6.0" step="0.1" onchange="updateVolumeSetting('takeProfitPercent', this.value)" style="padding: 6px; background: #2b3139; border: 1px solid #3d4650; color: #e1e1e1; border-radius: 4px; width: 120px;">
                        <span style="font-size: 11px; color: #848e9c; margin-left: 5px;">목표 수익률</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .manual-trade {
            max-width: 500px;
        }
        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            gap: 10px;
        }
        .form-row label {
            width: 100px;
            color: #848e9c;
            font-size: 14px;
        }
        .form-buttons {
            display: flex;
            margin-top: 15px;
        }
        .form-buttons button:hover {
            opacity: 0.9;
        }

        .strategy-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .setting-category {
            background: #2b3139;
            border-radius: 8px;
            padding: 15px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .setting-item label {
            width: 120px;
            font-size: 13px;
            color: #848e9c;
        }

        /* 토글 스위치 */
        .toggle-switch {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }

        .toggle-switch input {
            display: none;
        }

        .slider {
            position: relative;
            width: 44px;
            height: 24px;
            background: #3d4650;
            border-radius: 12px;
            transition: 0.3s;
        }

        .slider::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            left: 3px;
            bottom: 3px;
            background: #848e9c;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .slider {
            background: #0ecb81;
        }

        .toggle-switch input:checked + .slider::before {
            transform: translateX(20px);
            background: #fff;
        }

        .status-text {
            margin-left: 8px;
            font-size: 13px;
            color: #848e9c;
        }

        .toggle-switch input:checked ~ .status-text {
            color: #0ecb81;
        }
    </style>

    <script>
        // 페이지 로드 시 초기화
        async function initDashboard() {
            // LLM 최적화 상태 로드
            try {
                const statusResponse = await fetch('/api/optimizer/status');
                const status = await statusResponse.json();
                document.getElementById('llmServiceStatus').textContent = status.llmServiceAvailable ? '사용 가능' : '사용 불가';
                document.getElementById('lastOptimization').textContent = status.lastOptimizedAt || '없음';
            } catch (e) {
                console.error('LLM 상태 로드 실패:', e);
            }

            // 현재 설정값 로드
            await loadCurrentSettings();
        }

        async function loadCurrentSettings() {
            try {
                // Meme Scalper 설정 로드
                const memeEnabled = await getSetting('memescalper.enabled');
                const memePositionSize = await getSetting('memescalper.positionSizeKrw');
                const memeStopLoss = await getSetting('memescalper.stopLossPercent');
                const memeTakeProfit = await getSetting('memescalper.takeProfitPercent');

                if (memeEnabled !== null) {
                    document.getElementById('memeEnabled').checked = memeEnabled === 'true';
                    updateToggleText('memeEnabled', memeEnabled === 'true');
                }
                if (memePositionSize !== null) document.getElementById('memePositionSize').value = memePositionSize;
                if (memeStopLoss !== null) document.getElementById('memeStopLoss').value = memeStopLoss;
                if (memeTakeProfit !== null) document.getElementById('memeTakeProfit').value = memeTakeProfit;

                // Volume Surge 설정 로드
                const volumeEnabled = await getSetting('volumesurge.enabled');
                const volumePositionSize = await getSetting('volumesurge.positionSizeKrw');
                const volumeStopLoss = await getSetting('volumesurge.stopLossPercent');
                const volumeTakeProfit = await getSetting('volumesurge.takeProfitPercent');

                if (volumeEnabled !== null) {
                    document.getElementById('volumeEnabled').checked = volumeEnabled === 'true';
                    updateToggleText('volumeEnabled', volumeEnabled === 'true');
                }
                if (volumePositionSize !== null) document.getElementById('volumePositionSize').value = volumePositionSize;
                if (volumeStopLoss !== null) document.getElementById('volumeStopLoss').value = volumeStopLoss;
                if (volumeTakeProfit !== null) document.getElementById('volumeTakeProfit').value = volumeTakeProfit;
            } catch (e) {
                console.error('설정 로드 실패:', e);
            }
        }

        async function getSetting(key) {
            try {
                const response = await fetch('/api/settings/' + key);
                const result = await response.json();
                return result.success ? result.value : null;
            } catch (e) {
                return null;
            }
        }

        function updateToggleText(checkboxId, isEnabled) {
            const textEl = document.getElementById(checkboxId.replace('Enabled', 'StatusText'));
            if (textEl) {
                textEl.textContent = isEnabled ? '활성' : '비활성';
            }
        }

        // 30초마다 자동 새로고침
        setTimeout(() => {
            location.reload();
        }, 30000);

        // 주문 유형 변경 시 가격 입력 표시/숨김
        document.getElementById('orderType').addEventListener('change', function() {
            const priceRow = document.getElementById('priceRow');
            const amountLabel = document.getElementById('amountLabel');
            if (this.value === 'price') {
                priceRow.style.display = 'flex';
                amountLabel.textContent = '수량:';
            } else {
                priceRow.style.display = 'none';
                amountLabel.textContent = '금액 (KRW):';
            }
        });

        async function executeBuy() {
            const market = document.getElementById('tradeMarket').value;
            const orderType = document.getElementById('orderType').value;
            const price = document.getElementById('tradePrice').value;
            const amount = document.getElementById('tradeAmount').value;

            if (!amount || amount <= 0) {
                showResult('금액을 입력해주세요', false);
                return;
            }

            showResult('주문 중...', true, false);

            try {
                const params = new URLSearchParams({
                    market: market,
                    orderType: orderType,
                    amountKrw: orderType === 'market' ? amount : undefined,
                    quantity: orderType === 'price' ? amount : undefined,
                    price: orderType === 'price' ? price : undefined
                });

                const response = await fetch('/api/manual-trading/buy?' + params, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    showResult('매수 완료! ' + result.message, true);
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showResult('매수 실패: ' + result.error, false);
                }
            } catch (e) {
                showResult('오류: ' + e.message, false);
            }
        }

        async function executeSell() {
            const market = document.getElementById('tradeMarket').value;
            const orderType = document.getElementById('orderType').value;
            const price = document.getElementById('tradePrice').value;
            const amount = document.getElementById('tradeAmount').value;

            if (!amount || amount <= 0) {
                showResult('수량을 입력해주세요', false);
                return;
            }

            showResult('주문 중...', true, false);

            try {
                // 잔고 조회
                const balanceResponse = await fetch('/api/manual-trading/balance/' + market);
                const balance = await balanceResponse.json();

                if (!balance.success || !balance.balance || balance.balance <= 0) {
                    showResult('보유 코인이 없습니다', false);
                    return;
                }

                const params = new URLSearchParams({
                    market: market,
                    orderType: orderType,
                    quantity: orderType === 'market' ? balance.balance : amount,
                    price: orderType === 'price' ? price : undefined
                });

                const response = await fetch('/api/manual-trading/sell?' + params, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    showResult('매도 완료! ' + result.message, true);
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showResult('매도 실패: ' + result.error, false);
                }
            } catch (e) {
                showResult('오류: ' + e.message, false);
            }
        }

        function showResult(message, isSuccess, showOnly = true) {
            const resultDiv = document.getElementById('tradeResult');
            resultDiv.style.display = 'block';
            resultDiv.style.background = isSuccess === false ? '#f6465d20' : '#0ecb8120';
            resultDiv.style.color = isSuccess === false ? '#f6465d' : '#0ecb81';
            resultDiv.textContent = message;

            if (showOnly && isSuccess) {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 3000);
            }
        }

        // LLM 최적화
        async function runOptimization() {
            const resultDiv = document.getElementById('optimizationResult');
            resultDiv.style.display = 'block';
            resultDiv.style.background = '#2b3139';
            resultDiv.style.color = '#848e9c';
            resultDiv.textContent = '최적화 실행 중...';

            try {
                const response = await fetch('/api/optimizer/run', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    resultDiv.style.background = '#0ecb8120';
                    resultDiv.style.color = '#0ecb81';
                    resultDiv.textContent = result.result;
                } else {
                    resultDiv.style.background = '#f6465d20';
                    resultDiv.style.color = '#f6465d';
                    resultDiv.textContent = result.result || '최적화 실패';
                }
            } catch (e) {
                resultDiv.style.background = '#f6465d20';
                resultDiv.style.color = '#f6465d';
                resultDiv.textContent = '오류: ' + e.message;
            }
        }

        // 전략 설정 관리
        async function toggleMemeScalper() {
            const enabled = document.getElementById('memeEnabled').checked;
            await updateSetting('memescalper.enabled', enabled);
            updateToggleText('memeEnabled', enabled);
        }

        async function toggleVolumeSurge() {
            const enabled = document.getElementById('volumeEnabled').checked;
            await updateSetting('volumesurge.enabled', enabled);
            updateToggleText('volumeEnabled', enabled);
        }

        async function updateMemeSetting(key, value) {
            await updateSetting('memescalper.' + key, value);
        }

        async function updateVolumeSetting(key, value) {
            await updateSetting('volumesurge.' + key, value);
        }

        async function updateSetting(key, value) {
            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key: key, value: String(value) })
                });
                const result = await response.json();

                if (result.success) {
                    console.log('설정 저장됨:', key, value);
                } else {
                    alert('설정 저장 실패: ' + result.message);
                }
            } catch (e) {
                alert('설정 저장 오류: ' + e.message);
            }
        }

        // 수동 매도
        async function manualSell(button) {
            const market = button.dataset.market;
            const strategy = button.dataset.strategy;

            if (!confirm(`${market} (${strategy}) 포지션을 매도하시겠습니까?`)) {
                return;
            }

            button.disabled = true;
            button.textContent = '매도중...';

            try {
                const response = await fetch('/dashboard/manual-close', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `market=${encodeURIComponent(market)}&strategy=${encodeURIComponent(strategy)}`
                });
                const result = await response.json();

                if (result.success) {
                    alert('매도 완료!');
                    location.reload();
                } else {
                    alert('매도 실패: ' + (result.error || result.message || '알 수 없는 오류'));
                    button.disabled = false;
                    button.textContent = '매도';
                }
            } catch (e) {
                alert('매도 오류: ' + e.message);
                button.disabled = false;
                button.textContent = '매도';
            }
        }

        // 날짜별 조회
        function changeDate(offset) {
            const urlParams = new URLSearchParams(window.location.search);
            let daysAgo = parseInt(urlParams.get('daysAgo') || '0');
            console.log('Current daysAgo:', daysAgo, 'Offset:', offset);
            daysAgo = Math.max(0, Math.min(7, daysAgo + offset)); // 0-7일 범위 제한
            console.log('New daysAgo:', daysAgo);
            const newUrl = '/dashboard?daysAgo=' + daysAgo;
            console.log('Navigating to:', newUrl);
            window.location.href = newUrl;
        }

        // 페이지 로드 시 현재 파라미터 로깅
        console.log('Page loaded. URL:', window.location.href);
        console.log('daysAgo param:', new URLSearchParams(window.location.search).get('daysAgo'));
        console.log('currentDateStr from server:', document.querySelector('.date-current')?.textContent);
    </script>
</body>
</html>
